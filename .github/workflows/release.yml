name: Build and Release

on:
  push:
    branches:
      - master

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2
      
      - name: Setup NuGet
        uses: nuget/setup-nuget@v2
      
      - name: Restore NuGet packages
        run: nuget restore Switcheroo.sln
      
      - name: Build solution
        run: msbuild Switcheroo.sln /p:Configuration=Release /p:Platform="Any CPU"
      
      - name: Package release files
        run: |
          $releaseDir = "Switcheroo\bin\Release"
          $outputZip = "Switcheroo-Release.zip"
          Compress-Archive -Path "$releaseDir\*" -DestinationPath $outputZip
        shell: pwsh
      
      - name: Generate release tag
        id: tag
        run: |
          $timestamp = Get-Date -Format "yyyy.MM.dd.HHmmss"
          echo "tag=release-$timestamp" >> $env:GITHUB_OUTPUT
        shell: pwsh
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          draft: false
          prerelease: false
          files: Switcheroo-Release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
